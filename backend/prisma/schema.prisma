// Prisma schema for BATL user management system
// Database: PostgreSQL via Prisma ORM

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// Enums
enum Role {
  ADMIN
  ORGANIZER
  PLAYER
}

// Category System Enums (T005-T009)
enum CategoryType {
  SINGLES
  DOUBLES
}

enum AgeGroup {
  ALL_AGES
  AGE_20
  AGE_25
  AGE_30
  AGE_35
  AGE_40
  AGE_45
  AGE_50
  AGE_55
  AGE_60
  AGE_65
  AGE_70
  AGE_75
  AGE_80
}

enum Gender {
  MEN
  WOMEN
  MIXED
}

enum RegistrationStatus {
  ACTIVE
  WITHDRAWN
  SUSPENDED
}

enum TournamentStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum TournamentRegistrationStatus {
  REGISTERED
  WAITLISTED
  WITHDRAWN
  CANCELLED
}

enum WaitlistDisplayOrder {
  REGISTRATION_TIME
  ALPHABETICAL
}

// Tournament Rules Enums (T012-T015)
enum FormatType {
  KNOCKOUT
  GROUP
  SWISS
  COMBINED
}

enum MatchStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum BracketType {
  MAIN
  CONSOLATION
  PLACEMENT
}

enum MatchGuaranteeType {
  MATCH_1
  MATCH_2
  UNTIL_PLACEMENT
}

// Ranking System Enums (008-tournament-rankings)
enum RankingType {
  SINGLES // For singles categories
  PAIR // For pair rankings in doubles
  MEN // For individual men in doubles
  WOMEN // For individual women in doubles
}

enum RankingEntityType {
  PLAYER // Individual player
  PAIR // Doubles pair
}

enum CalculationMethod {
  PLACEMENT // Points based on final placement
  FINAL_ROUND // Points based on last round won
}

// Models

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  role          Role
  isActive      Boolean   @default(true)
  emailVerified Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?

  // Relationships
  sessions        Session[]
  auditLogs       AuditLog[]
  playerProfile   PlayerProfile?  @relation("UserProfile")
  createdProfiles PlayerProfile[] @relation("ProfileCreator")
  organizer       Organizer?      @relation("UserOrganizer")

  @@index([role])
  @@index([isActive])
}

model Session {
  id        String   @id
  userId    String
  data      String // JSON serialized
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?
  action     String
  entityType String?
  entityId   String?
  changes    String? // JSON serialized
  ipAddress  String
  userAgent  String?
  timestamp  DateTime @default(now())

  // Relationships
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([timestamp])
  @@index([userId, timestamp])
}

model PlayerProfile {
  id        String   @id @default(uuid())
  userId    String?  @unique // Nullable - profile can exist without account
  name      String
  email     String?  @unique // Email must be unique if provided (nullable allows multiple null values)
  phone     String?
  createdBy String // Organizer who created this profile
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Category System Fields (T010)
  birthDate DateTime? // Required for age validation
  gender    Gender? // Required for gender validation

  // Relationships
  user    User? @relation("UserProfile", fields: [userId], references: [id], onDelete: SetNull)
  creator User  @relation("ProfileCreator", fields: [createdBy], references: [id], onDelete: Restrict)

  // Category System Relationships (T010)
  categoryRegistrations   CategoryRegistration[]
  tournamentRegistrations TournamentRegistration[]

  // Tournament Rules Relationships (T008-T009)
  matchesAsPlayer1    Match[]            @relation("MatchPlayer1")
  matchesAsPlayer2    Match[]            @relation("MatchPlayer2")
  groupParticipations GroupParticipant[]

  // Doubles Pairs Relationships (006-doubles-pairs)
  doublesPairsAsPlayer1 DoublesPair[] @relation("DoublesPairPlayer1")
  doublesPairsAsPlayer2 DoublesPair[] @relation("DoublesPairPlayer2")
  
  // Ranking System Relationships (008-tournament-rankings)
  rankingEntries    RankingEntry[]
  tournamentResults TournamentResult[]

  @@index([userId])
  @@index([createdBy])
  @@index([name])
  @@index([email])
  @@index([birthDate]) // For age-based queries
  @@index([gender]) // For gender-based queries
}

// Category System Models (T011-T014)

model Category {
  id          String       @id @default(uuid())
  type        CategoryType // Singles or Doubles
  ageGroup    AgeGroup // Age threshold or ALL_AGES
  gender      Gender // Men, Women, or Mixed
  name        String // Auto-generated display name
  description String? // Optional category description
  
  // Ranking System Fields (008-tournament-rankings)
  countedTournamentsLimit Int @default(7) // Number of best tournaments counted for seeding
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relationships
  tournaments   Tournament[]
  registrations CategoryRegistration[]

  // Doubles Pairs Relationships (006-doubles-pairs)
  doublesPairs DoublesPair[]
  
  // Ranking System Relationships (008-tournament-rankings)
  rankingTables Ranking[]

  // Constraints (T015)
  @@unique([type, ageGroup, gender]) // Prevent duplicate categories (FR-005)
  @@index([type])
  @@index([ageGroup])
  @@index([gender])
}

model Organizer {
  id     String  @id @default(uuid())
  userId String  @unique
  name   String
  email  String
  phone  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  user                 User         @relation("UserOrganizer", fields: [userId], references: [id], onDelete: Cascade)
  organizedTournaments Tournament[] @relation("PrimaryOrganizer")
  deputyTournaments    Tournament[] @relation("DeputyOrganizer")

  @@index([userId])
}

model Location {
  id       String  @id @default(uuid())
  clubName String
  address  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  primaryTournaments Tournament[] @relation("PrimaryLocation")
  backupTournaments  Tournament[] @relation("BackupLocation")

  @@index([clubName])
}

model Tournament {
  id          String  @id @default(uuid())
  name        String // Tournament display name
  categoryId  String // Required: belongs to one category (FR-006)
  description String? // Optional tournament details

  // Location & Logistics (FR-032 to FR-042)
  locationId            String? // Primary location (club/address)
  backupLocationId      String? // Backup location for bad weather
  courts                Int? // Number of courts available (FR-034)
  capacity              Int? // Max registered players (null = unlimited)
  organizerId           String? // Primary organizer (FR-037)
  deputyOrganizerId     String? // Deputy organizer (FR-038)
  entryFee              Float? // Entry fee (null = free)
  rulesUrl              String? // Link to tournament rules
  prizeDescription      String? // Prize/award details
  registrationOpenDate  DateTime? // When registration opens
  registrationCloseDate DateTime? // When registration closes
  minParticipants       Int? // Minimum required participants

  // Waitlist Configuration
  waitlistDisplayOrder WaitlistDisplayOrder @default(REGISTRATION_TIME)

  // Tournament Rules and Format (T004)
  formatType          FormatType @default(KNOCKOUT) // Tournament format type
  formatConfig        String // JSON: Format-specific configuration
  defaultScoringRules String // JSON: Default match scoring rules

  // Scheduling
  startDate DateTime
  endDate   DateTime

  // Lifecycle
  status           TournamentStatus @default(SCHEDULED)
  lastStatusChange DateTime? // When status last changed

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  category                Category                 @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  location                Location?                @relation("PrimaryLocation", fields: [locationId], references: [id], onDelete: SetNull)
  backupLocation          Location?                @relation("BackupLocation", fields: [backupLocationId], references: [id], onDelete: SetNull)
  organizer               Organizer?               @relation("PrimaryOrganizer", fields: [organizerId], references: [id], onDelete: SetNull)
  deputyOrganizer         Organizer?               @relation("DeputyOrganizer", fields: [deputyOrganizerId], references: [id], onDelete: SetNull)
  tournamentRegistrations TournamentRegistration[]

  // Doubles Pairs Relationships (006-doubles-pairs)
  pairRegistrations PairRegistration[]

  // Tournament Rules Relationships (T004-T009)
  groups   Group[]
  brackets Bracket[]
  rounds   Round[]
  matches  Match[]
  
  // Ranking System Relationships (008-tournament-rankings)
  pointConfig       TournamentPointConfig?
  tournamentResults TournamentResult[]

  // Constraints (T015)
  @@index([categoryId])
  @@index([startDate])
  @@index([status])
  @@index([registrationOpenDate])
  @@index([registrationCloseDate])
  @@index([formatType]) // T123: Index for format type filtering
  @@index([locationId])
  @@index([organizerId])
}

model CategoryRegistration {
  id              String             @id @default(uuid())
  playerId        String // Foreign key to PlayerProfile
  categoryId      String // Foreign key to Category
  status          RegistrationStatus @default(ACTIVE)
  hasParticipated Boolean            @default(false) // True after first completed tournament
  registeredAt    DateTime           @default(now())
  withdrawnAt     DateTime? // Timestamp when withdrawn
  notes           String? // Optional admin notes
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  // Relationships
  player   PlayerProfile @relation(fields: [playerId], references: [id], onDelete: Cascade)
  category Category      @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  // Constraints (T015)
  @@unique([playerId, categoryId]) // One registration per player per category (FR-007)
  @@index([playerId])
  @@index([categoryId])
  @@index([status])
  @@index([hasParticipated])
}

// Tournament Registration Model (003-tournament-registration)

model TournamentRegistration {
  id           String                       @id @default(uuid())
  playerId     String // Foreign key to PlayerProfile
  tournamentId String // Foreign key to Tournament
  status       TournamentRegistrationStatus @default(REGISTERED)

  // Timestamps
  registrationTimestamp DateTime  @default(now()) // Used for waitlist ordering
  withdrawnAt           DateTime? // When player withdrew (if WITHDRAWN)
  cancelledAt           DateTime? // When tournament cancelled (if CANCELLED)

  // Waitlist Management
  promotedBy String? // 'SYSTEM' or userId of organizer who promoted
  promotedAt DateTime? // When promoted from waitlist
  demotedBy  String? // userId of organizer who demoted
  demotedAt  DateTime? // When demoted to waitlist

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  player     PlayerProfile @relation(fields: [playerId], references: [id], onDelete: Cascade)
  tournament Tournament    @relation(fields: [tournamentId], references: [id], onDelete: Cascade)

  // Constraints
  @@unique([playerId, tournamentId]) // One registration per player per tournament
  @@index([playerId])
  @@index([tournamentId])
  @@index([status])
  @@index([tournamentId, status, registrationTimestamp]) // Critical for waitlist queries
  @@index([registrationTimestamp])
}

// Tournament Rules Models (T005-T009)

model Group {
  id                  String  @id @default(uuid())
  tournamentId        String // Foreign key to Tournament
  groupNumber         Int // Group number (1-indexed)
  groupSize           Int // Actual size of this group (may be X or X-1)
  ruleOverrides       String? // JSON: Group-specific rule overrides
  advancementCriteria String? // JSON: For combined - who advances and to which bracket

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  tournament        Tournament         @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  matches           Match[]
  groupParticipants GroupParticipant[]

  // Constraints
  @@unique([tournamentId, groupNumber])
  @@index([tournamentId])
}

model Bracket {
  id             String             @id @default(uuid())
  tournamentId   String // Foreign key to Tournament
  bracketType    BracketType // MAIN, CONSOLATION, PLACEMENT
  matchGuarantee MatchGuaranteeType // 1_MATCH, 2_MATCH, UNTIL_PLACEMENT
  ruleOverrides  String? // JSON: Bracket-specific rule overrides
  placementRange String? // For PLACEMENT brackets: "4-8", "9-16", etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  tournament Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  rounds     Round[]
  matches    Match[]

  // Constraints
  @@index([tournamentId])
  @@index([bracketType])
}

model Round {
  id                   String  @id @default(uuid())
  tournamentId         String // Foreign key to Tournament
  bracketId            String? // Foreign key to Bracket (nullable for swiss)
  roundNumber          Int // Round number (1-indexed)
  ruleOverrides        String? // JSON: Round-specific rule overrides
  earlyTiebreakEnabled Boolean @default(false) // For "until placement": early tiebreak

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  tournament Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  bracket    Bracket?   @relation(fields: [bracketId], references: [id], onDelete: Cascade)
  matches    Match[]

  // Constraints
  @@unique([tournamentId, bracketId, roundNumber])
  @@index([tournamentId])
  @@index([bracketId])
}

model Match {
  id                 String      @id @default(uuid())
  tournamentId       String // Foreign key to Tournament
  groupId            String? // Foreign key to Group (for group/combined)
  bracketId          String? // Foreign key to Bracket (for knockout/combined)
  roundId            String? // Foreign key to Round (for knockout/swiss)
  matchNumber        Int // Match number within tournament
  player1Id          String // Foreign key to PlayerProfile (for singles, or representative player for doubles)
  player2Id          String // Foreign key to PlayerProfile (for singles, or representative player for doubles)
  pair1Id            String? // Foreign key to DoublesPair (for doubles tournaments only) - 006-doubles-pairs
  pair2Id            String? // Foreign key to DoublesPair (for doubles tournaments only) - 006-doubles-pairs
  status             MatchStatus @default(SCHEDULED)
  result             String? // JSON: Match result (scores, winner)
  ruleOverrides      String? // JSON: Match-specific rule overrides
  completedWithRules String? // JSON: Immutable snapshot of effective rules when completed
  completedAt        DateTime? // Timestamp when match was completed

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  tournament Tournament    @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  group      Group?        @relation(fields: [groupId], references: [id], onDelete: Cascade)
  bracket    Bracket?      @relation(fields: [bracketId], references: [id], onDelete: Cascade)
  round      Round?        @relation(fields: [roundId], references: [id], onDelete: Cascade)
  player1    PlayerProfile @relation("MatchPlayer1", fields: [player1Id], references: [id], onDelete: Restrict)
  player2    PlayerProfile @relation("MatchPlayer2", fields: [player2Id], references: [id], onDelete: Restrict)
  pair1      DoublesPair?  @relation("MatchPair1", fields: [pair1Id], references: [id], onDelete: Restrict) // 006-doubles-pairs
  pair2      DoublesPair?  @relation("MatchPair2", fields: [pair2Id], references: [id], onDelete: Restrict) // 006-doubles-pairs

  // Constraints
  @@index([tournamentId])
  @@index([groupId])
  @@index([bracketId])
  @@index([roundId])
  @@index([player1Id])
  @@index([player2Id])
  @@index([pair1Id]) // 006-doubles-pairs
  @@index([pair2Id]) // 006-doubles-pairs
  @@index([status])
}

model GroupParticipant {
  id           String @id @default(uuid())
  groupId      String // Foreign key to Group
  playerId     String // Foreign key to PlayerProfile
  seedPosition Int? // Seeding position (placeholder for future)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  group  Group         @relation(fields: [groupId], references: [id], onDelete: Cascade)
  player PlayerProfile @relation(fields: [playerId], references: [id], onDelete: Cascade)

  // Constraints
  @@unique([groupId, playerId])
  @@index([groupId])
  @@index([playerId])
}

// Doubles Pair Management Models (006-doubles-pairs)

model DoublesPair {
  id           String    @id @default(uuid())
  player1Id    String // Lower player ID (always sorted)
  player2Id    String // Higher player ID (always sorted)
  categoryId   String // Foreign key to Category (must be DOUBLES type)
  seedingScore Float     @default(0) // Combined ranking points for tournament seeding
  deletedAt    DateTime? // Soft delete timestamp (null = active)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relationships
  player1           PlayerProfile      @relation("DoublesPairPlayer1", fields: [player1Id], references: [id], onDelete: Restrict)
  player2           PlayerProfile      @relation("DoublesPairPlayer2", fields: [player2Id], references: [id], onDelete: Restrict)
  category          Category           @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  pairRegistrations PairRegistration[]
  matchesAsPair1    Match[]            @relation("MatchPair1")
  matchesAsPair2    Match[]            @relation("MatchPair2")
  
  // Ranking System Relationships (008-tournament-rankings)
  rankingEntries    RankingEntry[]
  tournamentResults TournamentResult[]

  // Constraints
  @@unique([player1Id, player2Id, categoryId]) // Prevents duplicate pairs in same category
  @@index([player1Id, deletedAt]) // Fast lookup of pairs containing player1
  @@index([player2Id, deletedAt]) // Fast lookup of pairs containing player2
  @@index([categoryId, deletedAt]) // Fast lookup of active pairs in category
  @@index([categoryId, seedingScore, deletedAt]) // Tournament bracket generation
}

model PairRegistration {
  id                    String                       @id @default(uuid())
  tournamentId          String // Foreign key to Tournament
  pairId                String // Foreign key to DoublesPair
  status                TournamentRegistrationStatus @default(REGISTERED)
  registrationTimestamp DateTime                     @default(now()) // Used for tie-breaking in seeding
  eligibilityOverride   Boolean                      @default(false) // True if organizer bypassed eligibility
  overrideReason        String? // Required if eligibilityOverride = true
  promotedAt            DateTime? // When promoted from waitlist
  demotedAt             DateTime? // When demoted to waitlist
  createdAt             DateTime                     @default(now())
  updatedAt             DateTime                     @updatedAt

  // Relationships
  tournament Tournament  @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  pair       DoublesPair @relation(fields: [pairId], references: [id], onDelete: Cascade)

  // Constraints
  @@unique([tournamentId, pairId]) // Pair can only register once per tournament
  @@index([tournamentId, status]) // Fast lookup of registrations by tournament and status
  @@index([tournamentId, registrationTimestamp]) // Tie-breaking for seeding
  @@index([pairId, status]) // Fast lookup of pair's active registrations
}

// Ranking System Models (008-tournament-rankings)

model Ranking {
  id          String            @id @default(uuid())
  categoryId  String // Foreign key to Category
  year        Int // Calendar year (e.g., 2025)
  type        RankingType // SINGLES, PAIR, MEN, WOMEN
  isArchived  Boolean           @default(false) // True for past years
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // Relationships
  category Category        @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  entries  RankingEntry[]

  // Constraints
  @@unique([categoryId, year, type]) // One ranking per category/year/type combination
  @@index([categoryId, year, isArchived])
  @@index([year, isArchived])
}

model RankingEntry {
  id                 String    @id @default(uuid())
  rankingId          String // Foreign key to Ranking
  entityType         RankingEntityType // PLAYER or PAIR
  playerId           String? // Foreign key to PlayerProfile (for PLAYER type)
  pairId             String? // Foreign key to DoublesPair (for PAIR type)
  rank               Int // Current rank position (1 = first place)
  totalPoints        Float     @default(0) // Sum of tournament points
  tournamentCount    Int       @default(0) // Number of tournaments participated
  lastTournamentDate DateTime? // Date of most recent tournament
  seedingScore       Float     @default(0) // Sum of best N tournaments for seeding
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // Relationships
  ranking          Ranking           @relation(fields: [rankingId], references: [id], onDelete: Cascade)
  player           PlayerProfile?    @relation(fields: [playerId], references: [id], onDelete: Cascade)
  pair             DoublesPair?      @relation(fields: [pairId], references: [id], onDelete: Cascade)
  tournamentResults TournamentResult[]

  // Constraints
  @@unique([rankingId, playerId]) // One entry per player per ranking
  @@unique([rankingId, pairId]) // One entry per pair per ranking
  @@index([rankingId, rank]) // Fast leaderboard queries
  @@index([playerId])
  @@index([pairId])
  @@index([rankingId, totalPoints]) // For sorting
  @@index([rankingId, totalPoints, lastTournamentDate, tournamentCount]) // Comprehensive tiebreaker index
}

model TournamentResult {
  id                String   @id @default(uuid())
  tournamentId      String // Foreign key to Tournament
  rankingEntryId    String // Foreign key to RankingEntry
  entityType        RankingEntityType // PLAYER or PAIR
  playerId          String? // Foreign key to PlayerProfile (for PLAYER type)
  pairId            String? // Foreign key to DoublesPair (for PAIR type)
  placement         Int? // Final placement (1st, 2nd, 3rd, etc.) - for PLACEMENT method
  finalRoundReached String? // Last round won (e.g., "FINAL", "SEMIFINAL") - for FINAL_ROUND method
  pointsAwarded     Float    @default(0) // Points earned in this tournament
  awardDate         DateTime @default(now()) // When points were awarded
  createdAt         DateTime @default(now())

  // Relationships
  tournament   Tournament      @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  rankingEntry RankingEntry    @relation(fields: [rankingEntryId], references: [id], onDelete: Cascade)
  player       PlayerProfile?  @relation(fields: [playerId], references: [id], onDelete: Cascade)
  pair         DoublesPair?    @relation(fields: [pairId], references: [id], onDelete: Cascade)

  // Constraints
  @@unique([tournamentId, rankingEntryId]) // One result per tournament per ranking entry
  @@index([tournamentId])
  @@index([rankingEntryId])
  @@index([playerId])
  @@index([pairId])
  @@index([awardDate])
}

model PointTable {
  id               String   @id @default(uuid())
  participantRange String // "2-4", "5-8", "9-16", "17-32"
  roundName        String // "FINAL", "SEMIFINAL", "QUARTERFINAL", etc.
  points           Float // Points awarded for reaching this round
  isConsolation    Boolean  @default(false) // True for consolation bracket rounds
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Constraints
  @@unique([participantRange, roundName, isConsolation])
  @@index([participantRange])
}

model TournamentPointConfig {
  id                   String            @id @default(uuid())
  tournamentId         String            @unique // Foreign key to Tournament
  calculationMethod    CalculationMethod @default(PLACEMENT) // PLACEMENT or FINAL_ROUND
  multiplicativeValue  Float             @default(2) // Multiplier for PLACEMENT method
  doublePointsEnabled  Boolean           @default(false) // 2x multiplier for special tournaments
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt

  // Relationships
  tournament Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)

  // Constraints
  @@index([tournamentId])
}
